// Customer.js - Customer Dashboard Logic

// Initialize Customer Dashboard
document.addEventListener('DOMContentLoaded', function() {
    checkCustomerLogin();
    loadCustomerDashboard();
});

// Check if customer is logged in
function checkCustomerLogin() {
    const user = localStorage.getItem('currentUser');
    if (!user) {
        redirectTo('index.html');
        return;
    }
    
    const currentUser = JSON.parse(user);
    if (currentUser.role !== 'customer') {
        redirectTo('index.html');
    }
}

// Load Customer Dashboard
function loadCustomerDashboard() {
    const customer = JSON.parse(localStorage.getItem('currentUser'));
    
    // Display welcome message
    const welcomeElement = document.getElementById('welcomeMessage');
    if (welcomeElement) {
        welcomeElement.textContent = `خوش آمدید، ${customer.name}!`;
    }
    
    // Display customer information
    displayCustomerInfo(customer);
    
    // Display order history
    displayOrderHistory();
    
    // Display stats
    displayCustomerStats();
}

// Display Customer Information
function displayCustomerInfo(customer) {
    const infoContainer = document.getElementById('customerInfo');
    if (!infoContainer) return;
    
    infoContainer.innerHTML = `
        <div class="info-card">
            <h3>اطلاعات شخصی</h3>
            <div class="info-row">
                <span class="label">نام:</span>
                <span class="value">${customer.name}</span>
            </div>
            <div class="info-row">
                <span class="label">ایمیل:</span>
                <span class="value">${customer.email}</span>
            </div>
            <div class="info-row">
                <span class="label">تلفن:</span>
                <span class="value">${customer.phone}</span>
            </div>
            <div class="info-row">
                <span class="label">آدرس:</span>
                <span class="value">${customer.address}</span>
            </div>
            <button class="btn-edit" onclick="openEditProfile()">ویرایش پروفایل</button>
        </div>
    `;
}

// Display Order History
function displayOrderHistory() {
    const ordersContainer = document.getElementById('orderHistory');
    if (!ordersContainer) return;
    
    const customer = JSON.parse(localStorage.getItem('currentUser'));
    const customerOrders = appState.orders.filter(o => o.customerId === customer.id);
    
    if (customerOrders.length === 0) {
        ordersContainer.innerHTML = '<p class="no-orders">هیچ سفارشی ندارید</p>';
        return;
    }
    
    let html = `
        <table class="orders-table">
            <thead>
                <tr>
                    <th>شماره سفارش</th>
                    <th>تاریخ</th>
                    <th>مبلغ</th>
                    <th>وضعیت</th>
                    <th>عملیات</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    customerOrders.forEach(order => {
        const statusClass = getStatusClass(order.status);
        html += `
            <tr>
                <td>${order.id}</td>
                <td>${order.orderDate}</td>
                <td>${formatPrice(order.totalAmount)}</td>
                <td><span class="status ${statusClass}">${order.status}</span></td>
                <td>
                    <button class="btn-view" onclick="viewOrderDetails('${order.id}')">
                        مشاهده
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    ordersContainer.innerHTML = html;
}

// Display Customer Stats
function displayCustomerStats() {
    const customer = JSON.parse(localStorage.getItem('currentUser'));
    const customerOrders = appState.orders.filter(o => o.customerId === customer.id);
    
    const totalSpent = customerOrders.reduce((sum, order) => sum + order.totalAmount, 0);
    const totalOrders = customerOrders.length;
    const deliveredOrders = customerOrders.filter(o => o.status === 'تحویل داده شده').length;
    
    const statsContainer = document.getElementById('customerStats');
    if (statsContainer) {
        statsContainer.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${totalOrders}</div>
                <div class="stat-label">تعداد سفارشات</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${formatPrice(totalSpent)}</div>
                <div class="stat-label">کل خریدتان</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${deliveredOrders}</div>
                <div class="stat-label">سفارشات تحویل داده شده</div>
            </div>
        `;
    }
}

// View Order Details
function viewOrderDetails(orderId) {
    const order = appState.orders.find(o => o.id === orderId);
    if (!order) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal order-detail-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button>
            <h2>جزئیات سفارش</h2>
            
            <div class="order-detail-section">
                <h3>اطلاعات کلی</h3>
                <div class="detail-row">
                    <span class="label">شماره سفارش:</span>
                    <span class="value">${order.id}</span>
                </div>
                <div class="detail-row">
                    <span class="label">تاریخ:</span>
                    <span class="value">${order.orderDate}</span>
                </div>
                <div class="detail-row">
                    <span class="label">وضعیت:</span>
                    <span class="value"><span class="status ${getStatusClass(order.status)}">${order.status}</span></span>
                </div>
                <div class="detail-row">
                    <span class="label">روش پرداخت:</span>
                    <span class="value">${getPaymentMethodName(order.paymentMethod)}</span>
                </div>
            </div>
            
            <div class="order-detail-section">
                <h3>محصولات</h3>
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>محصول</th>
                            <th>قیمت</th>
                            <th>تعداد</th>
                            <th>جمع</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${order.items.map(item => `
                            <tr>
                                <td>${item.productName}</td>
                                <td>${formatPrice(item.price)}</td>
                                <td>${item.quantity}</td>
                                <td>${formatPrice(item.price * item.quantity)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <div class="order-detail-section">
                <h3>آدرس ارسال</h3>
                <p>${order.shippingAddress}</p>
            </div>
            
            <div class="order-detail-section">
                <h3>خلاصه</h3>
                <div class="detail-row total">
                    <span class="label">جمع کل:</span>
                    <span class="value">${formatPrice(order.totalAmount)}</span>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
}

// Open Edit Profile
function openEditProfile() {
    const customer = JSON.parse(localStorage.getItem('currentUser'));
    const modal = document.createElement('div');
    modal.className = 'modal edit-profile-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button>
            <h2>ویرایش پروفایل</h2>
            
            <form onsubmit="saveProfileChanges(event)">
                <div class="form-group">
                    <label>نام:</label>
                    <input type="text" id="editName" value="${customer.name}" required>
                </div>
                
                <div class="form-group">
                    <label>ایمیل:</label>
                    <input type="email" id="editEmail" value="${customer.email}" required>
                </div>
                
                <div class="form-group">
                    <label>تلفن:</label>
                    <input type="tel" id="editPhone" value="${customer.phone}" required>
                </div>
                
                <div class="form-group">
                    <label>آدرس:</label>
                    <textarea id="editAddress" required>${customer.address}</textarea>
                </div>
                
                <button type="submit" class="btn-primary">ذخیره تغییرات</button>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
}

// Save Profile Changes
function saveProfileChanges(event) {
    event.preventDefault();
    
    const customer = JSON.parse(localStorage.getItem('currentUser'));
    customer.name = document.getElementById('editName').value;
    customer.email = document.getElementById('editEmail').value;
    customer.phone = document.getElementById('editPhone').value;
    customer.address = document.getElementById('editAddress').value;
    
    localStorage.setItem('currentUser', JSON.stringify(customer));
    
    // Update in appState
    const customerIndex = appState.customers.findIndex(c => c.id === customer.id);
    if (customerIndex !== -1) {
        appState.customers[customerIndex] = {
            ...appState.customers[customerIndex],
            name: customer.name,
            email: customer.email,
            phone: customer.phone,
            address: customer.address
        };
        saveState();
    }
    
    document.querySelector('.edit-profile-modal').remove();
    loadCustomerDashboard();
    showNotification('تغییرات با موفقیت ذخیره شدند!');
}

// Change Password
function openChangePassword() {
    const modal = document.createElement('div');
    modal.className = 'modal change-password-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button>
            <h2>تغییر رمز عبور</h2>
            
            <form onsubmit="handleChangePassword(event)">
                <div class="form-group">
                    <label>رمز عبور فعلی:</label>
                    <input type="password" id="currentPassword" required>
                </div>
                
                <div class="form-group">
                    <label>رمز عبور جدید:</label>
                    <input type="password" id="newPassword" required>
                </div>
                
                <div class="form-group">
                    <label>تأیید رمز عبور:</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                
                <button type="submit" class="btn-primary">تغییر رمز</button>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
}

// Handle Change Password
function handleChangePassword(event) {
    event.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        showNotification('رمز عبور جدید و تأیید آن مطابقت ندارند!', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showNotification('رمز عبور باید حداقل 6 کاراکتر باشد!', 'error');
        return;
    }
    
    const customer = JSON.parse(localStorage.getItem('currentUser'));
    const customerData = appState.customers.find(c => c.id === customer.id);
    
    if (customerData.password !== currentPassword) {
        showNotification('رمز عبور فعلی اشتباه است!', 'error');
        return;
    }
    
    customerData.password = newPassword;
    saveState();
    
    document.querySelector('.change-password-modal').remove();
    showNotification('رمز عبور با موفقیت تغییر یافت!');
}

// Get Status Class
function getStatusClass(status) {
    const statusClasses = {
        'درحال انتظار': 'status-pending',
        'تایید شده': 'status-confirmed',
        'درحال ارسال': 'status-shipping',
        'تحویل داده شده': 'status-delivered',
        'لغو شده': 'status-cancelled'
    };
    return statusClasses[status] || 'status-pending';
}

// Get Payment Method Name
function getPaymentMethodName(method) {
    const methods = {
        'card': 'کارت اعتباری',
        'transfer': 'انتقال بانکی',
        'cash': 'پرداخت در محل'
    };
    return methods[method] || method;
}