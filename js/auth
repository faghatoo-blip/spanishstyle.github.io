// Auth.js - Authentication System

// Check if user is already logged in
function checkUserLogin() {
    const user = localStorage.getItem('currentUser');
    if (user) {
        appState.currentUser = JSON.parse(user);
        appState.isLoggedIn = true;
        appState.userRole = appState.currentUser.role;
        updateUIAfterLogin();
    }
}

// Handle Login
function handleLogin(event) {
    event.preventDefault();
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    // Check Admin Login
    if (email === adminData.email && password === adminData.password) {
        appState.currentUser = {
            email: adminData.email,
            name: adminData.name,
            role: 'admin'
        };
        appState.isLoggedIn = true;
        appState.userRole = 'admin';
        localStorage.setItem('currentUser', JSON.stringify(appState.currentUser));
        closeLoginModal();
        redirectTo('admin.html');
        return;
    }
    
    // Check Customer Login
    const customer = appState.customers.find(c => c.email === email && c.password === password);
    if (customer) {
        appState.currentUser = {
            id: customer.id,
            name: customer.name,
            email: customer.email,
            phone: customer.phone,
            address: customer.address,
            role: 'customer'
        };
        appState.isLoggedIn = true;
        appState.userRole = 'customer';
        localStorage.setItem('currentUser', JSON.stringify(appState.currentUser));
        saveState();
        closeLoginModal();
        updateUIAfterLogin();
        showNotification('خوش آمدید! شما با موفقیت وارد شدید.');
        return;
    }
    
    showNotification('ایمیل یا رمز عبور اشتباه است!', 'error');
}

// Handle Register
function handleRegister(event) {
    event.preventDefault();
    
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const phone = document.getElementById('registerPhone').value;
    const address = document.getElementById('registerAddress').value;
    const password = document.getElementById('registerPassword').value;
    
    // Validation
    if (!isValidEmail(email)) {
        showNotification('لطفاً ایمیل معتبری وارد کنید!', 'error');
        return;
    }
    
    if (!isValidPhone(phone)) {
        showNotification('لطفاً شماره تلفن معتبری وارد کنید!', 'error');
        return;
    }
    
    if (password.length < 6) {
        showNotification('رمز عبور باید حداقل 6 کاراکتر باشد!', 'error');
        return;
    }
    
    // Check if email already exists
    if (appState.customers.find(c => c.email === email)) {
        showNotification('این ایمیل قبلاً ثبت‌نام شده است!', 'error');
        return;
    }
    
    // Create new customer
    const newCustomer = {
        id: appState.customers.length + 1,
        name: name,
        email: email,
        phone: phone,
        address: address,
        password: password,
        registeredDate: formatPersianDate(new Date()),
        status: 'فعال',
        totalOrders: 0,
        totalSpent: 0
    };
    
    appState.customers.push(newCustomer);
    saveState();
    
    closeRegisterModal();
    showNotification('ثبت‌نام با موفقیت انجام شد! اکنون می‌توانید وارد شوید.', 'success');
    
    // Clear form
    document.getElementById('registerName').value = '';
    document.getElementById('registerEmail').value = '';
    document.getElementById('registerPhone').value = '';
    document.getElementById('registerAddress').value = '';
    document.getElementById('registerPassword').value = '';
    
    // Show login modal
    setTimeout(() => {
        showLoginModal();
    }, 1500);
}

// Handle Logout
function handleLogout() {
    if (confirm('آیا مطمئن هستید که می‌خواهید خروج کنید؟')) {
        appState.currentUser = null;
        appState.isLoggedIn = false;
        appState.userRole = null;
        localStorage.removeItem('currentUser');
        saveState();
        updateUIAfterLogout();
        showNotification('شما با موفقیت خارج شدید.', 'success');
    }
}

// Update UI after login
function updateUIAfterLogin() {
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const registerBtn = document.querySelector('.btn-register');
    
    if (loginBtn) loginBtn.style.display = 'none';
    if (logoutBtn) logoutBtn.style.display = 'inline-block';
    if (registerBtn) registerBtn.style.display = 'none';
}

// Update UI after logout
function updateUIAfterLogout() {
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const registerBtn = document.querySelector('.btn-register');
    
    if (loginBtn) loginBtn.style.display = 'inline-block';
    if (logoutBtn) logoutBtn.style.display = 'none';
    if (registerBtn) registerBtn.style.display = 'inline-block';
}

// Show Login Modal
function showLoginModal() {
    document.getElementById('loginModal').style.display = 'flex';
    document.getElementById('registerModal').style.display = 'none';
}

// Close Login Modal
function closeLoginModal() {
    document.getElementById('loginModal').style.display = 'none';
}

// Show Register Modal
function showRegisterModal() {
    document.getElementById('registerModal').style.display = 'flex';
    document.getElementById('loginModal').style.display = 'none';
}

// Close Register Modal
function closeRegisterModal() {
    document.getElementById('registerModal').style.display = 'none';
}

// Switch to Register from Login
function switchToRegister() {
    closeLoginModal();
    showRegisterModal();
}

// Switch to Login from Register
function switchToLogin() {
    closeRegisterModal();
    showLoginModal();
}

// Close modals when clicking outside
window.addEventListener('click', function(event) {
    const loginModal = document.getElementById('loginModal');
    const registerModal = document.getElementById('registerModal');
    
    if (event.target == loginModal) {
        closeLoginModal();
    }
    if (event.target == registerModal) {
        closeRegisterModal();
    }
});

// Initialize auth on page load
document.addEventListener('DOMContentLoaded', function() {
    checkUserLogin();
});