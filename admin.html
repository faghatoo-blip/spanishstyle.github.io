// Admin.js - Admin Panel Management Logic

// Initialize Admin Panel
document.addEventListener('DOMContentLoaded', function() {
    checkAdminLogin();
    loadAdminDashboard();
});

// Check if admin is logged in
function checkAdminLogin() {
    const user = localStorage.getItem('currentUser');
    if (!user) {
        showAdminLoginPage();
        return;
    }
    
    const currentUser = JSON.parse(user);
    if (currentUser.role !== 'admin') {
        localStorage.removeItem('currentUser');
        showAdminLoginPage();
        return;
    }
    
    showAdminDashboard();
}

// Show Admin Login Page
function showAdminLoginPage() {
    const mainContent = document.getElementById('adminDashboard') || document.querySelector('main');
    if (!mainContent) return;
    
    mainContent.innerHTML = `
        <div class="admin-login-container">
            <div class="login-box">
                <h1>داشبورد مدیریت</h1>
                <p>ورود به پنل مدیریت</p>
                <form onsubmit="handleAdminLogin(event)">
                    <div class="form-group">
                        <label>ایمیل:</label>
                        <input type="email" id="adminEmail" required>
                    </div>
                    <div class="form-group">
                        <label>رمز عبور:</label>
                        <input type="password" id="adminPassword" required>
                    </div>
                    <button type="submit" class="btn-primary">ورود</button>
                </form>
            </div>
        </div>
    `;
}

// Handle Admin Login
function handleAdminLogin(event) {
    event.preventDefault();
    
    const email = document.getElementById('adminEmail').value;
    const password = document.getElementById('adminPassword').value;
    
    if (email === adminData.email && password === adminData.password) {
        const adminUser = {
            email: adminData.email,
            name: adminData.name,
            role: 'admin'
        };
        
        localStorage.setItem('currentUser', JSON.stringify(adminUser));
        appState.currentUser = adminUser;
        appState.isLoggedIn = true;
        appState.userRole = 'admin';
        saveState();
        
        checkAdminLogin();
        showNotification('خوش آمدید به پنل مدیریت!');
    } else {
        showNotification('ایمیل یا رمز عبور اشتباه است!', 'error');
    }
}

// Load Admin Dashboard
function loadAdminDashboard() {
    displayAdminStats();
    displayRecentOrders();
    loadProducts();
    loadCustomers();
    loadOrders();
}

// Display Admin Stats
function displayAdminStats() {
    const statsContainer = document.getElementById('adminStats');
    if (!statsContainer) return;
    
    const totalProducts = appState.products.length;
    const totalCustomers = appState.customers.length;
    const totalOrders = appState.orders.length;
    const totalRevenue = appState.orders.reduce((sum, order) => sum + order.totalAmount, 0);
    
    statsContainer.innerHTML = `
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-box"></i></div>
            <div class="stat-content">
                <div class="stat-value">${totalProducts}</div>
                <div class="stat-label">محصولات</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-content">
                <div class="stat-value">${totalCustomers}</div>
                <div class="stat-label">مشتریان</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
            <div class="stat-content">
                <div class="stat-value">${totalOrders}</div>
                <div class="stat-label">سفارشات</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-euro-sign"></i></div>
            <div class="stat-content">
                <div class="stat-value">${formatPrice(totalRevenue)}</div>
                <div class="stat-label">درآمد</div>
            </div>
        </div>
    `;
}

// Display Recent Orders
function displayRecentOrders() {
    const container = document.getElementById('recentOrders');
    if (!container) return;
    
    const recentOrders = appState.orders.slice(-5).reverse();
    
    let html = `
        <table class="admin-table">
            <thead>
                <tr>
                    <th>شماره سفارش</th>
                    <th>مشتری</th>
                    <th>مبلغ</th>
                    <th>وضعیت</th>
                    <th>تاریخ</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    recentOrders.forEach(order => {
        html += `
            <tr>
                <td>${order.id}</td>
                <td>${order.customerName}</td>
                <td>${formatPrice(order.totalAmount)}</td>
                <td><span class="status ${getStatusClass(order.status)}">${order.status}</span></td>
                <td>${order.orderDate}</td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

// Load and Display Products
function loadProducts() {
    const container = document.getElementById('productsTable');
    if (!container) return;
    
    let html = `
        <div class="section-header">
            <h2>مدیریت محصولات</h2>
            <button class="btn-primary" onclick="openAddProductModal()">
                <i class="fas fa-plus"></i> افزودن محصول
            </button>
        </div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>شناسه</th>
                    <th>نام</th>
                    <th>دسته‌بندی</th>
                    <th>قیمت</th>
                    <th>موجودی</th>
                    <th>وضعیت</th>
                    <th>عملیات</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    appState.products.forEach(product => {
        html += `
            <tr>
                <td>${product.id}</td>
                <td>${product.name}</td>
                <td>${product.category}</td>
                <td>${formatPrice(product.price)}</td>
                <td>${product.stock}</td>
                <td><span class="status-badge ${product.stock > 0 ? 'in-stock' : 'out-stock'}">${product.status}</span></td>
                <td>
                    <button class="btn-sm" onclick="editProduct(${product.id})">ویرایش</button>
                    <button class="btn-sm btn-danger" onclick="deleteProduct(${product.id})">حذف</button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

// Load and Display Customers
function loadCustomers() {
    const container = document.getElementById('customersTable');
    if (!container) return;
    
    let html = `
        <div class="section-header">
            <h2>مدیریت مشتریان</h2>
        </div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>شناسه</th>
                    <th>نام</th>
                    <th>ایمیل</th>
                    <th>تلفن</th>
                    <th>تعداد سفارشات</th>
                    <th>وضعیت</th>
                    <th>عملیات</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    appState.customers.forEach(customer => {
        const orderCount = appState.orders.filter(o => o.customerId === customer.id).length;
        html += `
            <tr>
                <td>${customer.id}</td>
                <td>${customer.name}</td>
                <td>${customer.email}</td>
                <td>${customer.phone}</td>
                <td>${orderCount}</td>
                <td><span class="status-badge status-active">${customer.status}</span></td>
                <td>
                    <button class="btn-sm" onclick="viewCustomerDetail(${customer.id})">مشاهده</button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

// Load and Display Orders
function loadOrders() {
    const container = document.getElementById('ordersTable');
    if (!container) return;
    
    let html = `
        <div class="section-header">
            <h2>مدیریت سفارشات</h2>
        </div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>شماره سفارش</th>
                    <th>مشتری</th>
                    <th>مبلغ</th>
                    <th>وضعیت</th>
                    <th>روش پرداخت</th>
                    <th>تاریخ</th>
                    <th>عملیات</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    appState.orders.forEach(order => {
        html += `
            <tr>
                <td>${order.id}</td>
                <td>${order.customerName}</td>
                <td>${formatPrice(order.totalAmount)}</td>
                <td><span class="status ${getStatusClass(order.status)}">${order.status}</span></td>
                <td>${getPaymentMethodName(order.paymentMethod)}</td>
                <td>${order.orderDate}</td>
                <td>
                    <button class="btn-sm" onclick="updateOrderStatus('${order.id}')">تغییر وضعیت</button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

// Open Add Product Modal
function openAddProductModal() {
    const modal = document.createElement('div');
    modal.className = 'modal add-product-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button>
            <h2>افزودن محصول جدید</h2>
            <form onsubmit="handleAddProduct(event)">
                <div class="form-group">
                    <label>نام محصول:</label>
                    <input type="text" id="newProductName" required>
                </div>
                <div class="form-group">
                    <label>توضیحات:</label>
                    <textarea id="newProductDesc" required></textarea>
                </div>
                <div class="form-group">
                    <label>دسته‌بندی:</label>
                    <select id="newProductCategory" required>
                        <option>سرامیک</option>
                        <option>بافت</option>
                        <option>تزیینی</option>
                        <option>جواهرات</option>
                        <option>دیگر</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>قیمت:</label>
                        <input type="number" id="newProductPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>موجودی:</label>
                        <input type="number" id="newProductStock" required>
                    </div>
                </div>
                <button type="submit" class="btn-primary">افزودن</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

// Handle Add Product
function handleAddProduct(event) {
    event.preventDefault();
    
    const newProduct = {
        id: appState.products.length + 1,
        name: document.getElementById('newProductName').value,
        description: document.getElementById('newProductDesc').value,
        category: document.getElementById('newProductCategory').value,
        price: parseFloat(document.getElementById('newProductPrice').value),
        stock: parseInt(document.getElementById('newProductStock').value),
        imageUrl: 'images/logo.jpg',
        status: 'فعال'
    };
    
    appState.products.push(newProduct);
    saveState();
    
    document.querySelector('.add-product-modal').remove();
    loadProducts();
    showNotification('محصول با موفقیت افزوده شد!');
}

// Edit Product
function editProduct(productId) {
    const product = appState.products.find(p => p.id === productId);
    if (!product) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal edit-product-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button>
            <h2>ویرایش محصول</h2>
            <form onsubmit="handleEditProduct(event, ${productId})">
                <div class="form-group">
                    <label>نام محصول:</label>
                    <input type="text" id="editProductName" value="${product.name}" required>
                </div>
                <div class="form-group">
                    <label>توضیحات:</label>
                    <textarea id="editProductDesc" required>${product.description}</textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>قیمت:</label>
                        <input type="number" id="editProductPrice" value="${product.price}" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>موجودی:</label>
                        <input type="number" id="editProductStock" value="${product.stock}" required>
                    </div>
                </div>
                <button type="submit" class="btn-primary">ذخیره</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

// Handle Edit Product
function handleEditProduct(event, productId) {
    event.preventDefault();
    
    const product = appState.products.find(p => p.id === productId);
    product.name = document.getElementById('editProductName').value;
    product.description = document.getElementById('editProductDesc').value;
    product.price = parseFloat(document.getElementById('editProductPrice').value);
    product.stock = parseInt(document.getElementById('editProductStock').value);
    
    saveState();
    document.querySelector('.edit-product-modal').remove();
    loadProducts();
    showNotification('محصول با موفقیت ویرایش شد!');
}

// Delete Product
function deleteProduct(productId) {
    if (confirm('آیا مطمئن هستید؟')) {
        appState.products = appState.products.filter(p => p.id !== productId);
        saveState();
        loadProducts();
        showNotification('محصول حذف شد!');
    }
}

// Update Order Status
function updateOrderStatus(orderId) {
    const order = appState.orders.find(o => o.id === orderId);
    if (!order) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal update-order-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button>
            <h2>تغییر وضعیت سفارش</h2>
            <form onsubmit="handleUpdateOrderStatus(event, '${orderId}')">
                <div class="form-group">
                    <label>وضعیت جدید:</label>
                    <select id="newOrderStatus" required>
                        <option value="درحال انتظار" ${order.status === 'درحال انتظار' ? 'selected' : ''}>درحال انتظار</option>
                        <option value="تایید شده" ${order.status === 'تایید شده' ? 'selected' : ''}>تایید شده</option>
                        <option value="درحال ارسال" ${order.status === 'درحال ارسال' ? 'selected' : ''}>درحال ارسال</option>
                        <option value="تحویل داده شده" ${order.status === 'تحویل داده شده' ? 'selected' : ''}>تحویل داده شده</option>
                        <option value="لغو شده" ${order.status === 'لغو شده' ? 'selected' : ''}>لغو شده</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">تحدیث</button>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

// Handle Update Order Status
function handleUpdateOrderStatus(event, orderId) {
    event.preventDefault();
    
    const order = appState.orders.find(o => o.id === orderId);
    order.status = document.getElementById('newOrderStatus').value;
    
    if (order.status === 'تحویل داده شده') {
        order.deliveryDate = formatPersianDate(new Date());
    }
    
    saveState();
    document.querySelector('.update-order-modal').remove();
    loadOrders();
    showNotification('وضعیت سفارش با موفقیت تحدیث شد!');
}

// View Customer Detail
function viewCustomerDetail(customerId) {
    const customer = appState.customers.find(c => c.id === customerId);
    if (!customer) return;
    
    const customerOrders = appState.orders.filter(o => o.customerId === customerId);
    const totalSpent = customerOrders.reduce((sum, order) => sum + order.totalAmount, 0);
    
    const modal = document.createElement('div');
    modal.className = 'modal customer-detail-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <button class="close-btn" onclick="this.closest('.modal').remove()"><i class="fas fa-times"></i></button>
            <h2>جزئیات مشتری</h2>
            
            <div class="detail-section">
                <h3>اطلاعات فردی</h3>
                <p><strong>نام:</strong> ${customer.name}</p>
                <p><strong>ایمیل:</strong> ${customer.email}</p>
                <p><strong>تلفن:</strong> ${customer.phone}</p>
                <p><strong>آدرس:</strong> ${customer.address}</p>
            </div>
            
            <div class="detail-section">
                <h3>آمار</h3>
                <p><strong>تعداد سفارشات:</strong> ${customerOrders.length}</p>
                <p><strong>مجموع خریدتان:</strong> ${formatPrice(totalSpent)}</p>
                <p><strong>تاریخ ثبت‌نام:</strong> ${customer.registeredDate}</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
}

// Show Admin Dashboard
function showAdminDashboard() {
    const mainContent = document.querySelector('main') || document.body;
    mainContent.innerHTML = `
        <div class="admin-container">
            <div id="adminStats"></div>
            <div id="recentOrders"></div>
            <div id="productsTable"></div>
            <div id="customersTable"></div>
            <div id="ordersTable"></div>
        </div>
    `;
    loadAdminDashboard();
}
